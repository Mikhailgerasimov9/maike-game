<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>M.AI.KE</title>
  <!-- –î–æ–±–∞–≤–ª—è–µ–º meta-—Ç–µ–≥ viewport –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: #000;
    }
    canvas {
      display: block;
      background: #111;
    }
    /* UI-—Å—á–µ—Ç—á–∏–∫ */
    #ui {
      position: absolute;
      top: 10px;
      left: 10px;
      color: #0f0;
      font-family: monospace;
      font-size: 20px;
      z-index: 10;
    }
    /* –°—Ç–∞—Ä—Ç–æ–≤—ã–π —ç–∫—Ä–∞–Ω */
    #startScreen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.85);
      color: #fff;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      font-family: sans-serif;
      text-align: center;
      padding: 20px;
      z-index: 20;
    }
    #startScreen h1 {
      font-size: 64px;
      margin-bottom: 20px;
    }
    #startScreen p {
      font-size: 20px;
      margin: 5px;
    }
    #startScreen ul {
      list-style: none;
      padding: 0;
      margin: 10px 0;
      font-size: 18px;
      text-align: left;
    }
    /* –ö—Ä—É–∂–æ–∫ –¥–ª—è —Å—Ç–∞—Ä—Ç–∞ –∏–≥—Ä—ã */
    #startCircle {
      width: 120px;
      height: 120px;
      background: radial-gradient(circle, #ff69b4, #ff1493);
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 24px;
      color: #fff;
      cursor: pointer;
      margin-top: 20px;
      transition: transform 0.3s ease;
      box-shadow: 0 0 15px rgba(255,20,147,0.8);
    }
    #startCircle:hover {
      transform: scale(1.1);
    }
    /* –≠–∫—Ä–∞–Ω –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —É—Ä–æ–≤–Ω—è */
    #levelCompleteScreen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.85);
      color: #fff;
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      font-family: sans-serif;
      text-align: center;
      padding: 20px;
      z-index: 30;
    }
    #levelCompleteScreen h1 {
      font-size: 48px;
      margin-bottom: 10px;
    }
    #levelCompleteScreen p {
      font-size: 24px;
      margin: 10px 0;
    }
    /* –ö—Ä—É–∂–æ–∫ –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å / –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è */
    #nextLevelButton {
      width: 120px;
      height: 120px;
      background: radial-gradient(circle, #32cd32, #228b22);
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 24px;
      color: #fff;
      cursor: pointer;
      margin-top: 20px;
      box-shadow: 0 0 15px rgba(34,139,34,0.8);
      transition: transform 0.3s ease;
    }
    #nextLevelButton:hover {
      transform: scale(1.1);
    }
    /* –≠–∫—Ä–∞–Ω –Ω–µ—É–¥–∞—á–∏ —É—Ä–æ–≤–Ω—è */
    #gameOver {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #fff;
      font-family: sans-serif;
      text-align: center;
      display: none;
      z-index: 20;
    }
    #gameOver h1 {
      font-size: 48px;
      margin-bottom: 10px;
    }
    #gameOver button {
      padding: 10px 20px;
      font-size: 20px;
      cursor: pointer;
    }
    /* On-screen D-Pad –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
    #dpad {
      position: fixed;
      bottom: 20px;
      left: 20px;
      z-index: 100;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #dpad button {
      width: 90px;       /* –£–≤–µ–ª–∏—á–µ–Ω–æ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ */
      height: 90px;      /* –£–≤–µ–ª–∏—á–µ–Ω–æ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ */
      margin: 15px;
      font-size: 32px;   /* –£–≤–µ–ª–∏—á–µ–Ω —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ */
      border-radius: 10px;
      background: rgba(255,255,255,0.8);
      border: none;
    }
    /* –ï—Å–ª–∏ —ç–∫—Ä–∞–Ω –µ—â–µ –º–µ–Ω—å—à–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –º–∞–ª–µ–Ω—å–∫–∏–µ —Å–º–∞—Ä—Ç—Ñ–æ–Ω—ã) ‚Äì –º–æ–∂–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å –µ—â–µ */
    @media (max-width: 480px) {
      #dpad button {
        width: 100px;
        height: 100px;
        margin: 20px;
        font-size: 36px;
      }
    }
  </style>
</head>
<body>
  <!-- UI-—Å—á–µ—Ç—á–∏–∫ -->
  <div id="ui">
    Score: <span id="score">0</span> | Time: <span id="time">0</span>
  </div>

  <!-- –°—Ç–∞—Ä—Ç–æ–≤—ã–π —ç–∫—Ä–∞–Ω -->
  <div id="startScreen">
    <h1>M.AI.KE</h1>
    <p id="highScoreDisplay">High Score: 0</p>
    <p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –∫–ª–∞–≤–∏—à–∏ <strong>W A S D</strong> –∏ —Å—Ç—Ä–µ–ª–∫–∞–º–∏</p>
    <p>–°–æ–±–∏—Ä–∞–π –¥—Ä—É–∑–µ–π –∏ –±–æ–Ω—É—Å—ã, –∏–∑–±–µ–≥–∞–π –≤—Ä–∞–∂–µ—Å–∫–∏—Ö –ø—É–ª—å!</p>
    <p>–ë–æ–Ω—É—Å—ã:</p>
    <ul>
      <li>‚Ä¢ –ì–æ–ª—É–±–æ–π (Score): +10 –æ—á–∫–æ–≤</li>
      <li>‚Ä¢ –ü—É—Ä–ø—É—Ä–Ω—ã–π (Speed): —É—Å–∫–æ—Ä–µ–Ω–∏–µ –Ω–∞ 5 —Å–µ–∫</li>
      <li>‚Ä¢ –°–∏–Ω–∏–π (Shield): –Ω–µ—É—è–∑–≤–∏–º–æ—Å—Ç—å –∫ –ø—É–ª—è–º –Ω–∞ 5 —Å–µ–∫</li>
      <li>‚Ä¢ –û—Ä–∞–Ω–∂–µ–≤—ã–π (Magnet): –ø—Ä–∏—Ç—è–≥–∏–≤–∞–µ—Ç –¥—Ä—É–∑–µ–π –Ω–∞ 5 —Å–µ–∫</li>
    </ul>
    <!-- –ö—Ä—É–∂–æ–∫ –¥–ª—è —Å—Ç–∞—Ä—Ç–∞ –∏–≥—Ä—ã -->
    <div id="startCircle" onclick="startGame()">START</div>
  </div>

  <!-- –≠–∫—Ä–∞–Ω –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —É—Ä–æ–≤–Ω—è -->
  <div id="levelCompleteScreen"></div>

  <!-- –≠–∫—Ä–∞–Ω –Ω–µ—É–¥–∞—á–∏ —É—Ä–æ–≤–Ω—è -->
  <div id="gameOver"></div>

  <canvas id="gameCanvas"></canvas>

  <!-- On-screen D-Pad –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
  <div id="dpad">
    <button id="btn-up">‚ñ≤</button>
    <div>
      <button id="btn-left">‚óÑ</button>
      <button id="btn-right">‚ñ∫</button>
    </div>
    <button id="btn-down">‚ñº</button>
  </div>

  <script>
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ canvas –∏ –æ—Å–Ω–æ–≤–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    const scoreEl = document.getElementById("score");
    const timeEl = document.getElementById("time");
    const gameOverEl = document.getElementById("gameOver");
    const startScreenEl = document.getElementById("startScreen");
    const highScoreDisplayEl = document.getElementById("highScoreDisplay");
    const levelCompleteScreenEl = document.getElementById("levelCompleteScreen");

    // –ù–∞ —Å—Ç–∞—Ä—Ç–µ –≤—Å–µ–≥–¥–∞ high score = 0
    let highScore = 0;
    updateHighScoreDisplay();

    // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —É—Ä–æ–≤–Ω–µ–π: –≤—Ä–µ–º—è 60 —Å–µ–∫, —Ü–µ–ª–∏: —É—Ä–æ–≤–µ–Ω—å 1 ‚Äì 20, —É—Ä–æ–≤–µ–Ω—å 2 ‚Äì 40, —É—Ä–æ–≤–µ–Ω—å 3 ‚Äì 50 –æ—á–∫–æ–≤;
    // –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è: –Ω–µ—Ç –Ω–∞ 1, 3 –Ω–∞ 2, 5 –Ω–∞ 3.
    const levels = [
      { timeLimit: 60, targetScore: 20, obstacles: false },
      { timeLimit: 60, targetScore: 40, obstacles: true, obstaclesCount: 3 },
      { timeLimit: 60, targetScore: 50, obstacles: true, obstaclesCount: 5 }
    ];
    let currentLevelIndex = 0;
    let currentLevel = levels[currentLevelIndex];

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –∏–≥—Ä–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let score = 0;
    let totalScore = 0; // —Å—É–º–º–∞—Ä–Ω—ã–π —Å—á–µ—Ç –ø–æ —É—Ä–æ–≤–Ω—è–º
    let timeLeft = currentLevel.timeLimit;
    let gameOver = false;
    let lastTime = Date.now();

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –º–æ–±–∏–ª—å–Ω—ã–º (touch –ø–æ–¥–¥–µ—Ä–∂–∫–∞)
    const isMobile = ('ontouchstart' in window);

    // –ù–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–µ —Å–∫–æ—Ä–æ—Å—Ç—å –≥–µ—Ä–æ—è –Ω–µ–º–Ω–æ–≥–æ –≤—ã—à–µ (–µ—Å–ª–∏ –Ω–µ –º–æ–±–∏–ª—å–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ)
    const baseSpeed = isMobile ? 3 : 4;

    // –û–±—ä–µ–∫—Ç –≥–µ—Ä–æ—è (—Ä–æ–±–æ—Ç AI)
    const hero = {
      x: canvas.width / 2,
      y: canvas.height / 2,
      radius: 20,
      baseSpeed: baseSpeed,
      speed: baseSpeed,
      dx: 0,
      dy: 0,
      boostTime: 0,
      shieldTime: 0,
      magnetTime: 0
    };

    // –ú–∞—Å—Å–∏–≤—ã –∏–≥—Ä–æ–≤—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤
    let friends = [];
    let bonuses = [];
    let enemies = [];
    let enemyBullets = [];
    let obstacles = [];

    // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è: –∫–ª–∞–≤–∏—à–∏ WASD –∏ —Å—Ç—Ä–µ–ª–∫–∏ (–º–∞–ø–ø–∏–Ω–≥ —Å—Ç—Ä–µ–ª–æ–∫ –Ω–∞ W/A/S/D)
    const keys = {};
    window.addEventListener("keydown", (e) => {
      let key = e.key;
      if (key === "ArrowUp") key = "w";
      if (key === "ArrowDown") key = "s";
      if (key === "ArrowLeft") key = "a";
      if (key === "ArrowRight") key = "d";
      keys[key.toLowerCase()] = true;
    });
    window.addEventListener("keyup", (e) => {
      let key = e.key;
      if (key === "ArrowUp") key = "w";
      if (key === "ArrowDown") key = "s";
      if (key === "ArrowLeft") key = "a";
      if (key === "ArrowRight") key = "d";
      keys[key.toLowerCase()] = false;
    });

    // --- On-screen D-Pad –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è ---
    function setupDpad() {
      const btnUp = document.getElementById('btn-up');
      const btnDown = document.getElementById('btn-down');
      const btnLeft = document.getElementById('btn-left');
      const btnRight = document.getElementById('btn-right');

      function setKey(button, keyChar) {
        button.addEventListener('touchstart', function(e) {
          e.preventDefault();
          keys[keyChar] = true;
        });
        button.addEventListener('touchend', function(e) {
          e.preventDefault();
          keys[keyChar] = false;
        });
        button.addEventListener('mousedown', function(e) {
          e.preventDefault();
          keys[keyChar] = true;
        });
        button.addEventListener('mouseup', function(e) {
          e.preventDefault();
          keys[keyChar] = false;
        });
      }
      setKey(btnUp, "w");
      setKey(btnDown, "s");
      setKey(btnLeft, "a");
      setKey(btnRight, "d");
    }
    setupDpad();

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ —á–∏—Å–ª–∞
    function randomRange(min, max) {
      return Math.random() * (max - min) + min;
    }

    // --- –°–æ–∑–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–≤—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ ---
    // –î—Ä—É–∑—å—è ‚Äì –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–µ —Ä–æ–±–æ—Ç—ã (–∏–∫–æ–Ω–∫–∞: —É–ª—ã–±–∞—é—â–µ–µ—Å—è –ª–∏—Ü–æ).
    // –ù–∞ —É—Ä–æ–≤–Ω—è—Ö 2 –∏ 3 –∑–∞–¥–∞—ë–º —Å–ª—É—á–∞–π–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ.
    function spawnFriend() {
      const friend = {
        x: randomRange(20, canvas.width - 20),
        y: randomRange(20, canvas.height - 20),
        radius: 15
      };
      if (currentLevelIndex >= 1) {
        friend.dx = randomRange(-30, 30);
        friend.dy = randomRange(-30, 30);
      } else {
        friend.dx = 0; friend.dy = 0;
      }
      friends.push(friend);
    }

    // –ë–æ–Ω—É—Å—ã ‚Äì —Å –∏–∫–æ–Ω–∫–∞–º–∏ (–∏—Å–ø–æ–ª—å–∑—É–µ–º Unicode‚Äë—Å–∏–º–≤–æ–ª—ã)
    function spawnBonus() {
      let bonusType;
      const r = Math.random();
      if (r < 0.4) bonusType = "score";
      else if (r < 0.7) bonusType = "speed";
      else if (r < 0.9) bonusType = "shield";
      else bonusType = "magnet";

      let bonusColor;
      switch (bonusType) {
        case "score": bonusColor = "#0ff"; break;
        case "speed": bonusColor = "#f0f"; break;
        case "shield": bonusColor = "#00f"; break;
        case "magnet": bonusColor = "#ffa500"; break;
      }

      const bonus = {
        x: randomRange(20, canvas.width - 20),
        y: randomRange(20, canvas.height - 20),
        radius: 12,
        type: bonusType,
        lifetime: 10,
        color: bonusColor
      };
      bonuses.push(bonus);
    }

    // –í—Ä–∞–≥–∏ ‚Äì –≤–∏—Ä—É—Å–æ–ø–æ–¥–æ–±–Ω—ã–µ —Å–æ–∑–¥–∞–Ω–∏—è —Å —à–∏–ø–∞–º–∏.
    // –ù–∞ 3‚Äë–µ–º —É—Ä–æ–≤–Ω–µ –≤—Ä–∞–≥–∞–º –∑–∞–¥–∞—ë–º –¥–≤–∏–∂–µ–Ω–∏–µ.
    function spawnEnemy() {
      const enemy = {
        x: randomRange(50, canvas.width - 50),
        y: randomRange(50, canvas.height - 50),
        radius: 18,
        shootCooldown: randomRange(1, 3)
      };
      if (currentLevelIndex === 2) {
        enemy.dx = randomRange(-30, 30);
        enemy.dy = randomRange(-30, 30);
      } else {
        enemy.dx = 0; enemy.dy = 0;
      }
      enemies.push(enemy);
    }

    // –ü—É–ª–∏ –≤—Ä–∞–≥–æ–≤
    function spawnEnemyBullet(enemy) {
      const dx = hero.x - enemy.x;
      const dy = hero.y - enemy.y;
      const distance = Math.sqrt(dx * dx + dy * dy);
      if (distance === 0) return;
      const bulletSpeed = 150;
      const vx = (dx / distance) * bulletSpeed;
      const vy = (dy / distance) * bulletSpeed;
      const bullet = {
        x: enemy.x,
        y: enemy.y,
        dx: vx,
        dy: vy,
        radius: 5,
        color: "#f00"
      };
      enemyBullets.push(bullet);
    }

    // –ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è ‚Äì —Ñ–∏–∑–∏—á–µ—Å–∫–∏–µ –æ–±—ä–µ–∫—Ç—ã (—á–µ—Ä–µ–∑ –Ω–∏—Ö –Ω–µ–ª—å–∑—è –ø—Ä–æ–π—Ç–∏)
    function spawnObstacles(count) {
      obstacles = [];
      for (let i = 0; i < count; i++) {
        const obstacle = {
          x: randomRange(50, canvas.width - 50),
          y: randomRange(50, canvas.height - 50),
          radius: 30
        };
        obstacles.push(obstacle);
      }
    }

    // --- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–≥—Ä–æ–≤—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ ---
    function updateEnemies(delta) {
      enemies.forEach(enemy => {
        enemy.shootCooldown -= delta;
        if (enemy.shootCooldown <= 0) {
          spawnEnemyBullet(enemy);
          enemy.shootCooldown = randomRange(2, 4);
        }
        if (enemy.dx !== 0) {
          enemy.x += enemy.dx * delta;
          enemy.y += enemy.dy * delta;
          if (enemy.x - enemy.radius < 0 || enemy.x + enemy.radius > canvas.width) {
            enemy.dx = -enemy.dx;
          }
          if (enemy.y - enemy.radius < 0 || enemy.y + enemy.radius > canvas.height) {
            enemy.dy = -enemy.dy;
          }
        }
      });
    }

    function updateEnemyBullets(delta) {
      for (let i = enemyBullets.length - 1; i >= 0; i--) {
        const bullet = enemyBullets[i];
        bullet.x += bullet.dx * delta;
        bullet.y += bullet.dy * delta;
        if (
          bullet.x < -bullet.radius ||
          bullet.x > canvas.width + bullet.radius ||
          bullet.y < -bullet.radius ||
          bullet.y > canvas.height + bullet.radius
        ) {
          enemyBullets.splice(i, 1);
          continue;
        }
        if (isColliding(hero, bullet)) {
          if (hero.shieldTime > 0) {
            enemyBullets.splice(i, 1);
          } else {
            score -= 5;
            if (score < 0) score = 0;
            enemyBullets.splice(i, 1);
          }
        }
      }
    }

    // –ü—Ä–æ—Å—Ç–µ–π—à–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è (–¥–ª—è –∫—Ä—É–≥–æ–≤)
    function isColliding(a, b) {
      const dx = a.x - b.x;
      const dy = a.y - b.y;
      const distance = Math.sqrt(dx * dx + dy * dy);
      return distance < (a.radius + b.radius);
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥–µ—Ä–æ—è —Å —É—á–µ—Ç–æ–º —Ñ–∏–∑–∏—á–µ—Å–∫–∏—Ö –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π
    function updateHero(delta) {
      const oldX = hero.x;
      const oldY = hero.y;
      hero.dx = 0;
      hero.dy = 0;
      if (keys["a"]) { hero.dx = -hero.speed; }
      if (keys["d"]) { hero.dx = hero.speed; }
      if (keys["w"]) { hero.dy = -hero.speed; }
      if (keys["s"]) { hero.dy = hero.speed; }
      hero.x += hero.dx;
      hero.y += hero.dy;
      if (hero.x - hero.radius < 0) hero.x = hero.radius;
      if (hero.x + hero.radius > canvas.width) hero.x = canvas.width - hero.radius;
      if (hero.y - hero.radius < 0) hero.y = hero.radius;
      if (hero.y + hero.radius > canvas.height) hero.y = canvas.height - hero.radius;
      if (currentLevel.obstacles) {
        for (let obs of obstacles) {
          if (isColliding(hero, obs)) {
            hero.x = oldX;
            hero.y = oldY;
            break;
          }
        }
      }
      if (hero.boostTime > 0) {
        hero.boostTime -= delta;
        if (hero.boostTime <= 0) hero.speed = hero.baseSpeed;
      }
      if (hero.shieldTime > 0) { hero.shieldTime -= delta; }
      if (hero.magnetTime > 0) { hero.magnetTime -= delta; }
    }

    // –ï—Å–ª–∏ –±–æ–Ω—É—Å Magnet –∞–∫—Ç–∏–≤–µ–Ω ‚Äì –¥—Ä—É–∑—å—è –ø—Ä–∏—Ç—è–≥–∏–≤–∞—é—Ç—Å—è –∫ –≥–µ—Ä–æ—é
    function updateMagnetEffect(delta) {
      if (hero.magnetTime > 0) {
        const magnetFactor = 2;
        friends.forEach(friend => {
          friend.x += (hero.x - friend.x) * magnetFactor * delta;
          friend.y += (hero.y - friend.y) * magnetFactor * delta;
        });
      }
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è –¥—Ä—É–∑–µ–π (–Ω–∞ —É—Ä–æ–≤–Ω—è—Ö 2 –∏ 3)
    function updateFriends(delta) {
      friends.forEach(friend => {
        if (friend.dx !== undefined) {
          friend.x += friend.dx * delta;
          friend.y += friend.dy * delta;
          if (friend.x - friend.radius < 0 || friend.x + friend.radius > canvas.width) {
            friend.dx = -friend.dx;
          }
          if (friend.y - friend.radius < 0 || friend.y + friend.radius > canvas.height) {
            friend.dy = -friend.dy;
          }
        }
      });
    }

    // --- –†–∏—Å–æ–≤–∞–Ω–∏–µ –∏–≥—Ä–æ–≤—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ ---
    function drawBackground() {
      ctx.fillStyle = "#111";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.strokeStyle = "#222";
      ctx.lineWidth = 1;
      const gridSize = 50;
      for (let x = 0; x < canvas.width; x += gridSize) {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, canvas.height);
        ctx.stroke();
      }
      for (let y = 0; y < canvas.height; y += gridSize) {
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(canvas.width, y);
        ctx.stroke();
      }
    }

    // –†–∏—Å–æ–≤–∞–Ω–∏–µ –≥–µ—Ä–æ—è.
    // –ù–∞ —É—Ä–æ–≤–Ω—è—Ö 1 –∏ 2 ‚Äî —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∫—Ä—É–≥; –Ω–∞ 3‚Äë–µ–º ‚Äî –æ–∫—Ä—É–≥–ª—ã–π –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫ —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º —ç–ª–µ–º–µ–Ω—Ç–æ–º (–≥–∞–ª—Å—Ç—É–∫) –∏ —è—Ä–∫–∏–º –æ—Ä–µ–æ–ª–æ–º.
    function drawHero() {
      ctx.save();
      ctx.translate(hero.x, hero.y);
      const gradient = ctx.createRadialGradient(0, 0, hero.radius * 0.3, 0, 0, hero.radius);
      gradient.addColorStop(0, "#ccc");
      gradient.addColorStop(1, "#888");
      
      if (currentLevelIndex === 2) {
        let w = hero.radius * 2;
        let h = hero.radius * 1.6;
        drawRoundedRect(ctx, -hero.radius, -hero.radius * 0.8, w, h, 10);
        ctx.fillStyle = gradient;
        ctx.fill();
        // –ì–ª–∞–∑–∞
        ctx.fillStyle = "#000";
        ctx.beginPath();
        ctx.arc(-hero.radius/2, -hero.radius*0.4, hero.radius/8, 0, Math.PI * 2);
        ctx.fill();
        ctx.beginPath();
        ctx.arc(hero.radius/2, -hero.radius*0.4, hero.radius/8, 0, Math.PI * 2);
        ctx.fill();
        // –ê–Ω—Ç–µ–Ω–Ω–∞
        ctx.strokeStyle = "#888";
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(0, -hero.radius*0.8);
        ctx.lineTo(0, -hero.radius*0.8 - 15);
        ctx.stroke();
        ctx.beginPath();
        ctx.arc(0, -hero.radius*0.8 - 20, 5, 0, Math.PI * 2);
        ctx.fillStyle = "#f00";
        ctx.fill();
        // –ì–∞–ª—Å—Ç—É–∫
        ctx.fillStyle = "#00f";
        ctx.beginPath();
        ctx.moveTo(0, 0);
        ctx.lineTo(-5, 20);
        ctx.lineTo(5, 20);
        ctx.closePath();
        ctx.fill();
        // –Ø—Ä–∫–∏–π —Å–≤–µ—Ç—è—â–∏–π—Å—è –æ—Ä–µ–æ–ª
        ctx.beginPath();
        ctx.arc(0, 0, hero.radius + 20, 0, Math.PI * 2);
        ctx.strokeStyle = "rgba(0,255,255,0.7)";
        ctx.lineWidth = 5;
        ctx.stroke();
        // –ë–æ–Ω—É—Å–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã
        if (hero.shieldTime > 0) {
          ctx.beginPath();
          ctx.arc(0, 0, hero.radius + 8, 0, Math.PI * 2);
          ctx.strokeStyle = "#00f";
          ctx.lineWidth = 3;
          ctx.stroke();
        }
        if (hero.magnetTime > 0) {
          ctx.beginPath();
          ctx.arc(0, 0, hero.radius + 15, 0, Math.PI * 2);
          ctx.strokeStyle = "#ffa500";
          ctx.lineWidth = 2;
          ctx.setLineDash([5,5]);
          ctx.stroke();
          ctx.setLineDash([]);
        }
      } else {
        // –†–∏—Å—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∫—Ä—É–≥ –¥–ª—è —É—Ä–æ–≤–Ω–µ–π 1 –∏ 2
        ctx.fillStyle = gradient;
        ctx.beginPath();
        ctx.arc(0, 0, hero.radius, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = "#000";
        ctx.beginPath();
        ctx.arc(-hero.radius/3, -hero.radius/5, hero.radius/8, 0, Math.PI * 2);
        ctx.fill();
        ctx.beginPath();
        ctx.arc(hero.radius/3, -hero.radius/5, hero.radius/8, 0, Math.PI * 2);
        ctx.fill();
        ctx.strokeStyle = "#888";
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(0, -hero.radius);
        ctx.lineTo(0, -hero.radius - 15);
        ctx.stroke();
        ctx.beginPath();
        ctx.arc(0, -hero.radius - 20, 5, 0, Math.PI * 2);
        ctx.fillStyle = "#f00";
        ctx.fill();
        if (currentLevelIndex >= 1) {
          ctx.fillStyle = "rgba(0,0,0,0.5)";
          ctx.fillRect(-hero.radius * 0.6, -hero.radius * 0.8, hero.radius * 1.2, hero.radius * 0.5);
          ctx.strokeStyle = "#0ff";
          ctx.lineWidth = 1;
          ctx.beginPath();
          ctx.moveTo(-hero.radius * 0.5, -hero.radius * 0.5);
          ctx.lineTo(hero.radius * 0.5, -hero.radius * 0.5);
          ctx.stroke();
        }
        if (hero.shieldTime > 0) {
          ctx.beginPath();
          ctx.arc(0, 0, hero.radius + 8, 0, Math.PI * 2);
          ctx.strokeStyle = "#00f";
          ctx.lineWidth = 3;
          ctx.stroke();
        }
        if (hero.magnetTime > 0) {
          ctx.beginPath();
          ctx.arc(0, 0, hero.radius + 15, 0, Math.PI * 2);
          ctx.strokeStyle = "#ffa500";
          ctx.lineWidth = 2;
          ctx.setLineDash([5,5]);
          ctx.stroke();
          ctx.setLineDash([]);
        }
      }
      ctx.restore();
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è –æ–∫—Ä—É–≥–ª–æ–≥–æ –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∞ (–¥–ª—è –≥–µ—Ä–æ—è –Ω–∞ 3-–º —É—Ä–æ–≤–Ω–µ)
    function drawRoundedRect(ctx, x, y, width, height, radius) {
      ctx.beginPath();
      ctx.moveTo(x + radius, y);
      ctx.lineTo(x + width - radius, y);
      ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
      ctx.lineTo(x + width, y + height - radius);
      ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
      ctx.lineTo(x + radius, y + height);
      ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
      ctx.lineTo(x, y + radius);
      ctx.quadraticCurveTo(x, y, x + radius, y);
      ctx.closePath();
    }

    // –†–∏—Å–æ–≤–∞–Ω–∏–µ –¥—Ä—É–∑–µ–π ‚Äì –¥—Ä—É–∂–µ–ª—é–±–Ω—ã—Ö —Ä–æ–±–æ—Ç–æ–≤
    function drawFriends() {
      friends.forEach(friend => { drawFriend(friend); });
    }
    function drawFriend(friend) {
      ctx.save();
      ctx.translate(friend.x, friend.y);
      ctx.fillStyle = "#ff0";
      ctx.beginPath();
      ctx.arc(0, 0, friend.radius, 0, Math.PI * 2);
      ctx.fill();
      ctx.fillStyle = "#000";
      ctx.beginPath();
      ctx.arc(-friend.radius/3, -friend.radius/4, friend.radius/5, 0, Math.PI * 2);
      ctx.fill();
      ctx.beginPath();
      ctx.arc(friend.radius/3, -friend.radius/4, friend.radius/5, 0, Math.PI * 2);
      ctx.fill();
      ctx.strokeStyle = "#000";
      ctx.beginPath();
      ctx.arc(0, 0, friend.radius/2, 0, Math.PI);
      ctx.stroke();
      ctx.restore();
    }

    // –†–∏—Å–æ–≤–∞–Ω–∏–µ –±–æ–Ω—É—Å–æ–≤ ‚Äì —Å –∏–∫–æ–Ω–∫–∞–º–∏
    function drawBonuses() {
      bonuses.forEach(bonus => {
        ctx.save();
        ctx.translate(bonus.x, bonus.y);
        ctx.beginPath();
        ctx.arc(0, 0, bonus.radius, 0, Math.PI * 2);
        ctx.fillStyle = bonus.color;
        ctx.fill();
        ctx.fillStyle = "#fff";
        ctx.font = bonus.radius * 1.5 + "px Arial";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        let icon = "";
        if (bonus.type === "score") { icon = "‚òÖ"; }
        else if (bonus.type === "speed") { icon = "‚ö°"; }
        else if (bonus.type === "shield") { icon = "üõ°"; }
        else if (bonus.type === "magnet") { icon = "üß≤"; }
        ctx.fillText(icon, 0, 0);
        ctx.restore();
      });
    }

    // –†–∏—Å–æ–≤–∞–Ω–∏–µ –≤—Ä–∞–≥–æ–≤ ‚Äì –≤–∏—Ä—É—Å–æ–ø–æ–¥–æ–±–Ω—ã—Ö —Å–æ–∑–¥–∞–Ω–∏–π —Å —à–∏–ø–∞–º–∏
    function drawEnemies() {
      enemies.forEach(enemy => { drawEnemy(enemy); });
    }
    function drawEnemy(enemy) {
      ctx.save();
      ctx.translate(enemy.x, enemy.y);
      ctx.fillStyle = "#f00";
      ctx.beginPath();
      ctx.arc(0, 0, enemy.radius, 0, Math.PI * 2);
      ctx.fill();
      ctx.strokeStyle = "#fff";
      for (let i = 0; i < 8; i++) {
        let angle = i * (Math.PI * 2 / 8);
        let startX = Math.cos(angle) * enemy.radius;
        let startY = Math.sin(angle) * enemy.radius;
        let endX = Math.cos(angle) * (enemy.radius + 5);
        let endY = Math.sin(angle) * (enemy.radius + 5);
        ctx.beginPath();
        ctx.moveTo(startX, startY);
        ctx.lineTo(endX, endY);
        ctx.stroke();
      }
      ctx.restore();
    }

    // –†–∏—Å–æ–≤–∞–Ω–∏–µ –≤—Ä–∞–∂–µ—Å–∫–∏—Ö –ø—É–ª—å
    function drawEnemyBullets() {
      enemyBullets.forEach(bullet => {
        ctx.beginPath();
        ctx.arc(bullet.x, bullet.y, bullet.radius, 0, Math.PI * 2);
        ctx.fillStyle = bullet.color;
        ctx.fill();
      });
    }

    // –†–∏—Å–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π
    function drawObstacles() {
      obstacles.forEach(obstacle => {
        ctx.beginPath();
        ctx.arc(obstacle.x, obstacle.y, obstacle.radius, 0, Math.PI * 2);
        ctx.fillStyle = "#555";
        ctx.fill();
      });
    }

    // --- –ò–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª ---
    function gameLoop() {
      if (gameOver) return;
      const now = Date.now();
      const delta = (now - lastTime) / 1000;
      lastTime = now;
      timeLeft -= delta;
      if (timeLeft <= 0) {
        timeLeft = 0;
        finishLevel();
        return;
      }
      updateHero(delta);
      updateEnemies(delta);
      updateEnemyBullets(delta);
      updateMagnetEffect(delta);
      if (currentLevelIndex >= 1) { updateFriends(delta); }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –±–æ–Ω—É—Å—ã (—É–º–µ–Ω—å—à–∞–µ–º –∏—Ö –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏)
      bonuses = bonuses.filter(bonus => {
        bonus.lifetime -= delta;
        return bonus.lifetime > 0;
      });
      
      // –°—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ –≥–µ—Ä–æ—è —Å –¥—Ä—É–∑—å—è–º–∏
      for (let i = friends.length - 1; i >= 0; i--) {
        if (isColliding(hero, friends[i])) {
          friends.splice(i, 1);
          score += 1;
        }
      }
      
      // –°—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ –≥–µ—Ä–æ—è —Å –±–æ–Ω—É—Å–∞–º–∏
      for (let i = bonuses.length - 1; i >= 0; i--) {
        if (isColliding(hero, bonuses[i])) {
          const bonus = bonuses[i];
          switch (bonus.type) {
            case "score":
              score += 10;
              break;
            case "speed":
              hero.speed = hero.baseSpeed * 2;
              hero.boostTime = 5;
              break;
            case "shield":
              hero.shieldTime = 5;
              break;
            case "magnet":
              hero.magnetTime = 5;
              break;
          }
          bonuses.splice(i, 1);
        }
      }
      
      // –°—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ –≥–µ—Ä–æ—è —Å –≤—Ä–∞–≥–∞–º–∏ (—É–±–∏—Ä–∞–µ–º –≤—Ä–∞–≥–æ–≤)
      for (let i = enemies.length - 1; i >= 0; i--) {
        if (isColliding(hero, enemies[i])) {
          enemies.splice(i, 1);
        }
      }
      
      scoreEl.textContent = score;
      timeEl.textContent = Math.ceil(timeLeft);
      drawBackground();
      drawFriends();
      drawBonuses();
      drawEnemies();
      drawEnemyBullets();
      if (currentLevel.obstacles) { drawObstacles(); }
      drawHero();
      requestAnimationFrame(gameLoop);
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è –æ–∫—Ä—É–≥–ª–æ–≥–æ –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–∞ (–¥–ª—è –≥–µ—Ä–æ—è –Ω–∞ 3-–º —É—Ä–æ–≤–Ω–µ)
    function drawRoundedRect(ctx, x, y, width, height, radius) {
      ctx.beginPath();
      ctx.moveTo(x + radius, y);
      ctx.lineTo(x + width - radius, y);
      ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
      ctx.lineTo(x + width, y + height - radius);
      ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
      ctx.lineTo(x + radius, y + height);
      ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
      ctx.lineTo(x, y + radius);
      ctx.quadraticCurveTo(x, y, x + radius, y);
      ctx.closePath();
    }

    // --- –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è ---
    function finishLevel() {
      gameOver = true;
      if (score >= currentLevel.targetScore) {
        totalScore += score;
        if (currentLevelIndex < levels.length - 1) {
          let message = (currentLevelIndex === 1)
                        ? "–û–ì–û! –í—ã –±–ª–∏–∑–∫–∏ –∫ –ø–æ–±–µ–¥–µ, –µ—â–µ —á—É—Ç—å-—á—É—Ç—å!"
                        : "AI –∞–ø–ª–æ–¥–∏—Ä—É–µ—Ç –≤–∞–º! –í—ã –∫—Ä–∞—Å–∞–≤—á–∏–∫!";
          const nextLevel = levels[currentLevelIndex + 1];
          levelCompleteScreenEl.innerHTML = `
            <h1>${message}</h1>
            <p>–°–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å: ${currentLevelIndex + 2} (–¶–µ–ª—å: ${nextLevel.targetScore} –æ—á–∫–æ–≤)</p>
            <p>–û–±—â–∏–π —Å—á–µ—Ç: ${totalScore}</p>
            <div id="nextLevelButton" onclick="startNextLevel()" style="width:120px; height:120px; background: radial-gradient(circle, #32cd32, #228b22); border-radius:50%; display:flex; justify-content:center; align-items:center; font-size:24px; color:#fff; cursor:pointer; margin-top:20px; box-shadow:0 0 15px rgba(34,139,34,0.8);">–ù–∞—á–∞—Ç—å</div>
          `;
          levelCompleteScreenEl.style.display = "flex";
        } else {
          levelCompleteScreenEl.innerHTML = `
            <h1>–í—ã –Ω–∞—Å—Ç–æ—è—â–∏–π AI –≥–µ—Ä–æ–π! –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º, –≤—ã –≤—ã–∏–≥—Ä–∞–ª–∏!</h1>
            <p>–û–±—â–∏–π —Å—á–µ—Ç: ${totalScore}</p>
            <div id="nextLevelButton" onclick="restartAll()" style="width:120px; height:120px; background: radial-gradient(circle, #32cd32, #228b22); border-radius:50%; display:flex; justify-content:center; align-items:center; font-size:24px; color:#fff; cursor:pointer; margin-top:20px; box-shadow:0 0 15px rgba(34,139,34,0.8);">–ü—Ä–æ–π—Ç–∏ –µ—â–µ —Ä–∞–∑</div>
          `;
          levelCompleteScreenEl.style.display = "flex";
        }
      } else {
        gameOverEl.innerHTML = `
          <h1>–ù–µ –æ–≥–æ—Ä—á–∞–π—Å—è, –¥–∞–≤–∞–π –µ—â–µ —Ä–∞–∑–æ–∫</h1>
          <p>–û–±—â–∏–π —Å—á–µ—Ç: ${totalScore}</p>
          <button onclick="restartGame()" style="padding:10px 20px; font-size:20px; cursor:pointer;">–î–∞–≤–∞–π –µ—â–µ —Ä–∞–∑–æ–∫</button>
        `;
        gameOverEl.style.display = "block";
      }
    }

    // --- –§—É–Ω–∫—Ü–∏–∏ –∑–∞–ø—É—Å–∫–∞ —É—Ä–æ–≤–Ω—è –∏ –∏–≥—Ä—ã ---
    function startLevel() {
      score = 0;
      timeLeft = currentLevel.timeLimit;
      gameOver = false;
      lastTime = Date.now();
      hero.x = canvas.width / 2;
      hero.y = canvas.height / 2;
      hero.speed = hero.baseSpeed;
      hero.boostTime = 0;
      hero.shieldTime = 0;
      hero.magnetTime = 0;
      friends = [];
      bonuses = [];
      enemies = [];
      enemyBullets = [];
      obstacles = [];
      if (currentLevel.obstacles) {
        spawnObstacles(currentLevel.obstaclesCount);
      }
      gameOverEl.style.display = "none";
      levelCompleteScreenEl.style.display = "none";
      gameLoop();
    }
    window.startGame = function() {
      highScore = 0;
      totalScore = 0;
      updateHighScoreDisplay();
      currentLevelIndex = 0;
      currentLevel = levels[currentLevelIndex];
      startScreenEl.style.display = "none";
      startLevel();
    };
    window.startNextLevel = function() {
      levelCompleteScreenEl.style.display = "none";
      currentLevelIndex++;
      currentLevel = levels[currentLevelIndex];
      startLevel();
    };
    window.restartGame = function() {
      startLevel();
    };
    window.restartAll = function() {
      currentLevelIndex = 0;
      currentLevel = levels[currentLevelIndex];
      totalScore = 0;
      startLevel();
    };

    function updateHighScoreDisplay() {
      highScoreDisplayEl.textContent = "High Score: " + highScore;
    }
    window.addEventListener("resize", () => {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    });

    // –ò–Ω—Ç–µ—Ä–≤–∞–ª—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –¥—Ä—É–∑–µ–π, –±–æ–Ω—É—Å–æ–≤ –∏ –≤—Ä–∞–≥–æ–≤
    setInterval(() => { if (!gameOver) spawnFriend(); }, 1500);
    setInterval(() => { if (!gameOver) spawnBonus(); }, 7000);
    setInterval(() => { if (!gameOver) spawnEnemy(); }, 8000);
  </script>
</body>
</html>
